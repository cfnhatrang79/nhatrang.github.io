<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIN-PRO v8 | Quản Lý Tài Chính</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #f97316; }
        body { font-family: 'Inter', sans-serif; background-color: #000; color: #e0e0e0; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .glass { background: rgba(10, 10, 10, 0.85); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .card-active { border-color: var(--accent); background: rgba(249, 115, 22, 0.05); }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #222; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }
    </style>
</head>
<body class="overflow-hidden antialiased">

    <!-- Loader -->
    <div id="loader" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-2 border-orange-500 border-t-transparent rounded-full animate-spin mb-4 shadow-[0_0_15px_rgba(249,115,22,0.5)]"></div>
        <p class="mono text-[10px] tracking-[0.4em] uppercase text-orange-500 animate-pulse">Establishing Secure Connection...</p>
    </div>

    <!-- Login Screen -->
    <div id="auth-screen" class="hidden fixed inset-0 z-[90] bg-black flex items-center justify-center p-4">
        <div class="w-full max-w-sm glass p-10 rounded-3xl shadow-2xl border border-zinc-900">
            <div class="w-16 h-16 bg-orange-600 rounded-2xl flex items-center justify-center mx-auto mb-8 text-black shadow-[0_0_30px_rgba(234,88,12,0.4)]">
                <i data-lucide="lock" stroke-width="3"></i>
            </div>
            <h2 class="text-2xl font-black uppercase text-white mb-1 text-center tracking-tighter italic">HỆ THỐNG FIN-PRO</h2>
            <p class="text-[8px] font-black text-zinc-600 uppercase tracking-[0.4em] mb-10 text-center underline decoration-orange-600 underline-offset-4">Internal Access Only</p>
            
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[8px] font-black text-zinc-500 uppercase tracking-widest ml-1">Account ID</label>
                    <input id="uid" type="text" class="w-full p-4 bg-zinc-950 border border-zinc-900 rounded-xl mono text-xs text-white outline-none focus:border-orange-600 transition-all" placeholder="ADMIN / STAFF">
                </div>
                <div class="space-y-1">
                    <label class="text-[8px] font-black text-zinc-500 uppercase tracking-widest ml-1">Security Code</label>
                    <input id="upass" type="password" class="w-full p-4 bg-zinc-950 border border-zinc-900 rounded-xl mono text-xs text-white outline-none focus:border-orange-600 transition-all" placeholder="••••••••">
                </div>
                <div id="auth-error" class="text-[10px] text-red-500 font-bold hidden text-center">Xác thực thất bại. Vui lòng thử lại.</div>
                <button onclick="handleLogin()" class="w-full py-4 bg-orange-600 text-black rounded-xl font-black text-[10px] uppercase tracking-[0.3em] hover:bg-orange-500 active:scale-[0.98] transition-all mt-6 shadow-xl shadow-orange-900/20">
                    Verify Identity
                </button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="hidden flex h-screen">
        <!-- Sidebar -->
        <aside class="w-20 md:w-64 flex flex-col bg-[#050505] border-r border-zinc-900">
            <div class="p-6 md:p-8 flex items-center justify-center md:justify-start gap-3">
                <div class="w-10 h-10 bg-orange-600 rounded-lg flex items-center justify-center text-black shadow-lg shadow-orange-900/20 shrink-0">
                    <i data-lucide="zap" size="20" stroke-width="3"></i>
                </div>
                <div class="hidden md:block">
                    <h1 class="font-black text-xl tracking-tighter text-white uppercase italic leading-none">FIN-PRO <span class="text-orange-500">v8</span></h1>
                    <p class="text-[7px] text-zinc-600 font-bold uppercase tracking-widest mt-1">Institutional Grade</p>
                </div>
            </div>

            <nav class="flex-1 px-4 space-y-2 mt-10" id="nav-menu">
                <!-- Nav items generated by JS -->
            </nav>

            <div class="p-4 border-t border-zinc-900">
                <button onclick="logout()" class="w-full flex items-center justify-center gap-2 py-3 text-zinc-500 hover:text-red-500 transition-colors">
                    <i data-lucide="log-out" size="18"></i>
                    <span class="hidden md:block text-[10px] font-black uppercase tracking-widest">Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Workspace -->
        <main class="flex-1 flex flex-col bg-black overflow-hidden">
            <header class="h-20 border-b border-zinc-900 flex items-center justify-between px-8 bg-[#050505]/50 backdrop-blur-xl">
                <div class="flex items-center gap-4">
                    <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                    <span class="text-[10px] font-black text-zinc-400 uppercase tracking-[0.3em]" id="current-page-name">Dashboard</span>
                </div>
                <div class="flex items-center gap-6">
                    <div class="hidden md:flex flex-col items-end">
                        <span class="text-[10px] font-black text-white uppercase tracking-wider" id="user-display-name">Admin Access</span>
                        <span class="text-[8px] font-bold text-zinc-600 uppercase tracking-widest">System Node: JP-01</span>
                    </div>
                    <div class="w-10 h-10 rounded-full border border-zinc-800 bg-zinc-950 flex items-center justify-center text-orange-500">
                        <i data-lucide="user" size="18"></i>
                    </div>
                </div>
            </header>

            <div id="viewport" class="flex-1 overflow-y-auto p-8 md:p-12 space-y-10">
                <!-- Content View -->
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // Global environment variables
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fin-pro-v8-demo';
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let state = {
            currentTab: 'dashboard',
            role: localStorage.getItem('fin_v8_session') || null,
            customers: [],
            transactions: [],
            capital: { total: 500000000 },
            user: null
        };

        const menu = [
            { id: 'dashboard', label: 'Tổng quan', icon: 'layout-dashboard' },
            { id: 'collections', label: 'Thu nợ ngày', icon: 'calendar-check' },
            { id: 'customers', label: 'Khách hàng', icon: 'users' },
            { id: 'ledger', label: 'Nhật ký giao dịch', icon: 'scroll-text' }
        ];

        // Init Auth FIRST
        const initAuth = async () => {
            try {
                if (authToken) {
                    await signInWithCustomToken(auth, authToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
            }
        };

        window.onload = () => {
            lucide.createIcons();
            initAuth();
            
            onAuthStateChanged(auth, (user) => {
                state.user = user;
                if (user && state.role) {
                    initSystem();
                } else {
                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('auth-screen').classList.remove('hidden');
                }
            });
        };

        window.handleLogin = () => {
            const u = document.getElementById('uid').value.toLowerCase();
            const p = document.getElementById('upass').value;
            const err = document.getElementById('auth-error');
            
            // Simple validation logic
            if((u === 'admin' || u === 'staff') && p !== '') {
                state.role = u;
                localStorage.setItem('fin_v8_session', u);
                err.classList.add('hidden');
                if (state.user) {
                    initSystem();
                }
            } else {
                err.classList.remove('hidden');
            }
        };

        window.logout = () => {
            localStorage.removeItem('fin_v8_session');
            location.reload();
        };

        function initSystem() {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('user-display-name').innerText = state.role.toUpperCase() + ' Access';
            
            setupRealtime();
            renderNav();
            render();
        }

        function setupRealtime() {
            if (!state.user) return; // Guard clause for Firebase Rule 3

            // Path following Rule 1: /artifacts/{appId}/public/data/{collection}
            const getPath = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);
            
            // Listeners with mandatory error callbacks
            onSnapshot(getPath('customers'), (snap) => {
                state.customers = snap.docs.map(d => ({id: d.id, ...d.data()}));
                render();
            }, (err) => console.error("Customers Stream Error:", err));

            onSnapshot(getPath('transactions'), (snap) => {
                state.transactions = snap.docs.map(d => ({id: d.id, ...d.data()}));
                render();
            }, (err) => console.error("Transactions Stream Error:", err));
        }

        function renderNav() {
            const nav = document.getElementById('nav-menu');
            nav.innerHTML = menu.map(item => `
                <button onclick="switchTab('${item.id}')" class="w-full flex items-center justify-center md:justify-start gap-4 px-4 py-4 rounded-2xl transition-all ${state.currentTab === item.id ? 'bg-orange-600/10 text-orange-500 border-l-2 border-orange-600' : 'text-zinc-500 hover:text-white hover:bg-zinc-900'}">
                    <i data-lucide="${item.icon}" size="20"></i>
                    <span class="hidden md:block text-[10px] font-black uppercase tracking-[0.2em]">${item.label}</span>
                </button>
            `).join('');
            lucide.createIcons();
        }

        window.switchTab = (id) => {
            state.currentTab = id;
            document.getElementById('current-page-name').innerText = id.replace(/-/g, ' ');
            renderNav();
            render();
        };

        function render() {
            const vp = document.getElementById('viewport');
            
            if (state.currentTab === 'dashboard') {
                const out = state.customers.reduce((acc, c) => acc + (Number(c.loanAmount) || 0), 0);
                const collected = state.transactions.reduce((acc, t) => acc + (Number(t.amount) || 0), 0);
                const cash = state.capital.total + collected - out;

                vp.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 glass p-10 rounded-[2rem] relative overflow-hidden group">
                            <p class="text-[10px] font-black uppercase text-zinc-500 tracking-[0.4em] mb-4">Total Liquidity</p>
                            <h2 class="text-6xl font-black text-white tracking-tighter tabular-nums mb-12">
                                ${cash.toLocaleString()}<span class="text-orange-500 text-xl ml-3">VND</span>
                            </h2>
                            <div class="grid grid-cols-2 gap-12 pt-10 border-t border-zinc-900/50">
                                <div>
                                    <p class="text-[8px] font-bold text-zinc-600 uppercase tracking-widest mb-2">Vốn Điều Lệ</p>
                                    <p class="text-2xl font-black text-white mono">${state.capital.total.toLocaleString()}</p>
                                </div>
                                <div>
                                    <p class="text-[8px] font-bold text-zinc-600 uppercase tracking-widest mb-2">Tiền Đang Cho Vay</p>
                                    <p class="text-2xl font-black text-orange-500 mono">${out.toLocaleString()}</p>
                                </div>
                            </div>
                            <i data-lucide="activity" class="absolute right-[-20px] bottom-[-20px] w-64 h-64 text-orange-500/5 rotate-12 group-hover:scale-110 transition-transform duration-1000"></i>
                        </div>
                        <div class="glass p-10 rounded-[2rem] border-orange-900/20 bg-orange-950/5 flex flex-col justify-between">
                            <div>
                                <div class="w-14 h-14 bg-orange-600 rounded-2xl flex items-center justify-center text-black shadow-xl shadow-orange-900/30 mb-8">
                                    <i data-lucide="bar-chart-3" size="24"></i>
                                </div>
                                <p class="text-[9px] font-black text-zinc-500 uppercase tracking-[0.3em] mb-2">Lợi Nhuận Gộp</p>
                                <p class="text-4xl font-black text-white mono tabular-nums">${collected.toLocaleString()}</p>
                            </div>
                            <div class="flex items-center gap-3 text-[10px] font-black text-emerald-500 uppercase tracking-widest mt-8">
                                <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                                Health Status: Optimal
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        ${renderStat('Hợp đồng', state.customers.length, 'file-text')}
                        ${renderStat('HĐ Đang vay', state.customers.filter(c=>c.status==='active').length, 'zap')}
                        ${renderStat('Quá hạn', state.customers.filter(c=>isOverdue(c)).length, 'alert-circle', true)}
                        ${renderStat('Hiệu suất', '98.2%', 'trending-up')}
                    </div>
                `;
            } else if (state.currentTab === 'collections') {
                const active = state.customers.filter(c => c.status === 'active');
                vp.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        ${active.length === 0 ? '<div class="col-span-full text-center py-20 text-zinc-700 font-bold uppercase tracking-widest">Không có hợp đồng đang hoạt động</div>' : active.map(c => `
                            <div class="glass p-8 rounded-[1.5rem] relative group border-zinc-900 hover:border-orange-600/50 transition-all">
                                <div class="flex justify-between items-start mb-10">
                                    <div>
                                        <h4 class="font-black text-white uppercase text-sm tracking-widest">${c.name}</h4>
                                        <p class="text-[10px] mono text-zinc-600 mt-2 uppercase">Gốc: <span class="text-zinc-400">${Number(c.loanAmount).toLocaleString()}</span></p>
                                    </div>
                                    <span class="text-[8px] font-black px-2 py-1 rounded bg-zinc-950 text-zinc-500 border border-zinc-800 uppercase tracking-widest">ID: ${c.id.slice(-4)}</span>
                                </div>
                                <div class="flex items-end justify-between mb-8">
                                    <div>
                                        <p class="text-[8px] font-black text-zinc-700 uppercase tracking-widest mb-1">Tiền đóng ngày</p>
                                        <p class="text-2xl font-black text-orange-500 mono">${Number(c.dailyAmount).toLocaleString()}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-[8px] font-black text-zinc-700 uppercase tracking-widest mb-1">Đã đóng</p>
                                        <p class="text-xs font-black text-white mono">${(Number(c.paidAmount) || 0).toLocaleString()}</p>
                                    </div>
                                </div>
                                <button onclick="confirmCollection('${c.id}', ${c.dailyAmount})" class="w-full py-4 bg-zinc-950 border border-zinc-900 text-zinc-500 rounded-xl font-black text-[9px] uppercase tracking-[0.3em] hover:bg-orange-600 hover:text-black hover:border-orange-600 transition-all active:scale-[0.95]">
                                    Xác Nhận Đóng Tiền
                                </button>
                                ${isOverdue(c) ? `<div class="absolute -top-3 -right-3 bg-red-600 text-white px-3 py-1 rounded-lg text-[9px] font-black uppercase shadow-lg shadow-red-900/40">Trễ Hạn</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (state.currentTab === 'ledger') {
                const txs = [...state.transactions].sort((a,b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));
                vp.innerHTML = `
                    <div class="glass rounded-[2rem] overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-[#080808] border-b border-zinc-900">
                                <tr>
                                    <th class="p-6 text-[10px] font-black text-zinc-500 uppercase tracking-widest">Thời gian</th>
                                    <th class="p-6 text-[10px] font-black text-zinc-500 uppercase tracking-widest">Khách hàng</th>
                                    <th class="p-6 text-[10px] font-black text-zinc-500 uppercase tracking-widest">Loại</th>
                                    <th class="p-6 text-[10px] font-black text-zinc-500 uppercase tracking-widest text-right">Số tiền</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-zinc-900/50">
                                ${txs.length === 0 ? '<tr><td colspan="4" class="p-10 text-center text-zinc-800 uppercase font-black tracking-widest">Chưa có giao dịch nào</td></tr>' : txs.map(t => `
                                    <tr class="hover:bg-zinc-900/20 transition-colors">
                                        <td class="p-6 mono text-[11px] text-zinc-500">${t.date ? new Date(t.date.seconds * 1000).toLocaleString('vi-VN') : 'N/A'}</td>
                                        <td class="p-6 text-sm font-black text-white uppercase">${t.customerName}</td>
                                        <td class="p-6">
                                            <span class="text-[8px] font-black px-2 py-1 rounded bg-zinc-950 text-zinc-600 border border-zinc-800 uppercase tracking-widest">THU_TIEN_NGAY</span>
                                        </td>
                                        <td class="p-6 text-right font-black text-emerald-500 mono text-base">+${Number(t.amount).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (state.currentTab === 'customers') {
                 vp.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-black uppercase tracking-tighter text-white">Quản lý khách hàng</h3>
                        <button onclick="addMockCustomer()" class="px-6 py-2 bg-zinc-900 text-zinc-400 border border-zinc-800 rounded-lg text-[10px] font-black uppercase tracking-widest hover:border-orange-600 hover:text-orange-500 transition-all">+ Thêm khách hàng (Mock)</button>
                    </div>
                    <div class="glass rounded-[2rem] overflow-hidden">
                         <table class="w-full text-left">
                            <thead class="bg-[#080808] border-b border-zinc-900">
                                <tr>
                                    <th class="p-6 text-[10px] font-black text-zinc-500 uppercase tracking-widest">Tên khách</th>
                                    <th class="p-6 text-[10px] font-black text-zinc-500 uppercase tracking-widest">Gốc vay</th>
                                    <th class="p-6 text-[10px] font-black text-zinc-500 uppercase tracking-widest">Đóng ngày</th>
                                    <th class="p-6 text-[10px] font-black text-zinc-500 uppercase tracking-widest text-right">Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${state.customers.map(c => `
                                     <tr class="border-b border-zinc-900/50">
                                        <td class="p-6 font-black text-white uppercase">${c.name}</td>
                                        <td class="p-6 mono text-zinc-400">${Number(c.loanAmount).toLocaleString()}</td>
                                        <td class="p-6 mono text-orange-500">${Number(c.dailyAmount).toLocaleString()}</td>
                                        <td class="p-6 text-right">
                                            <span class="px-3 py-1 rounded-full text-[8px] font-black uppercase tracking-widest ${c.status === 'active' ? 'bg-emerald-500/10 text-emerald-500' : 'bg-zinc-800 text-zinc-500'}">
                                                ${c.status}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                         </table>
                    </div>
                 `;
            }
            lucide.createIcons();
        }

        function renderStat(label, val, icon, isAlert = false) {
            return `
                <div class="glass p-6 rounded-2xl border-l-4 ${isAlert ? 'border-l-red-600 bg-red-950/5' : 'border-l-zinc-800'}">
                    <div class="flex items-center gap-3 mb-4">
                        <i data-lucide="${icon}" size="14" class="${isAlert ? 'text-red-500' : 'text-zinc-600'}"></i>
                        <p class="text-[8px] font-black text-zinc-500 uppercase tracking-widest">${label}</p>
                    </div>
                    <p class="text-2xl font-black ${isAlert ? 'text-red-500' : 'text-white'} mono">${val}</p>
                </div>
            `;
        }

        window.confirmCollection = async (id, amt) => {
            if (!state.user) return;
            const cust = state.customers.find(c => c.id === id);
            try {
                // Ensure atomic-like behavior with paths from Rule 1
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                    customerId: id,
                    customerName: cust.name,
                    amount: amt,
                    date: Timestamp.now(),
                    type: 'daily'
                });
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'customers', id), {
                    paidAmount: (Number(cust.paidAmount) || 0) + amt
                });
            } catch(e) {
                console.error("Update Failed:", e);
            }
        };

        window.addMockCustomer = async () => {
            if (!state.user) return;
            const names = ["Nguyễn Văn A", "Trần Thị B", "Lê Văn C", "Phạm Minh D"];
            const randomName = names[Math.floor(Math.random() * names.length)];
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'customers'), {
                    name: randomName,
                    loanAmount: 10000000,
                    dailyAmount: 200000,
                    paidAmount: 0,
                    status: 'active',
                    createdAt: Timestamp.now()
                });
            } catch(e) {
                console.error("Add Mock Failed:", e);
            }
        };

        function isOverdue(customer) {
            const myTxs = state.transactions
                .filter(t => t.customerId === customer.id)
                .sort((a,b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));
            if(myTxs.length === 0) return false;
            const lastDate = myTxs[0].date?.seconds * 1000;
            const diffDays = (Date.now() - lastDate) / (1000 * 3600 * 24);
            return diffDays > 1.2; 
        }

    </script>
</body>
</html>
